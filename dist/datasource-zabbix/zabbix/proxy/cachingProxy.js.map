{"version":3,"sources":["../../../../src/datasource-zabbix/zabbix/proxy/cachingProxy.js"],"names":["callOnce","func","promiseKeeper","funcScope","hash","getRequestHash","arguments","Promise","resolve","apply","then","result","cacheRequest","funcName","self","cache","cacheObject","cacheEnabled","_isExpired","value","timestamp","Date","now","args","argsJson","JSON","stringify","getHash","CachingProxy","cacheOptions","enabled","ttl","promises","proxyfied","proxyfy","object_age","String","prototype","i","chr","len","length","charCodeAt"],"mappings":"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","file":"cachingProxy.js","sourcesContent":["/**\n * This module allows to deduplicate function calls with the same params and\n * cache result of function call.\n */\n\nexport class CachingProxy {\n\n  constructor(cacheOptions) {\n    this.cacheEnabled = cacheOptions.enabled;\n    this.ttl          = cacheOptions.ttl || 600000; // 10 minutes by default\n\n    // Internal objects for data storing\n    this.cache = {};\n    this.promises = {};\n  }\n\n  /**\n   * Check that result is present in the cache and is up to date or send request otherwise.\n   */\n  cacheRequest(func, funcName, funcScope) {\n    return cacheRequest(func, funcName, funcScope, this);\n  }\n\n  /**\n   * Wrap request to prevent multiple calls with same params when request is waiting for response.\n   */\n  proxyfy(func, funcName, funcScope) {\n    if (!this.promises[funcName]) {\n      this.promises[funcName] = {};\n    }\n    const promiseKeeper = this.promises[funcName];\n    return callOnce(func, promiseKeeper, funcScope);\n  }\n\n  proxyfyWithCache(func, funcName, funcScope) {\n    let proxyfied = this.proxyfy(func, funcName, funcScope);\n    return this.cacheRequest(proxyfied, funcName, funcScope);\n  }\n\n  _isExpired(cacheObject) {\n    if (cacheObject) {\n      let object_age = Date.now() - cacheObject.timestamp;\n      return !(cacheObject.timestamp && object_age < this.ttl);\n    } else {\n      return true;\n    }\n  }\n}\n\n/**\n * Wrap request to prevent multiple calls\n * with same params when waiting for result.\n */\nfunction callOnce(func, promiseKeeper, funcScope) {\n  return function() {\n    var hash = getRequestHash(arguments);\n    if (!promiseKeeper[hash]) {\n      promiseKeeper[hash] = Promise.resolve(\n        func.apply(funcScope, arguments)\n        .then(result => {\n          promiseKeeper[hash] = null;\n          return result;\n        })\n      );\n    }\n    return promiseKeeper[hash];\n  };\n}\n\nfunction cacheRequest(func, funcName, funcScope, self) {\n  return function() {\n    if (!self.cache[funcName]) {\n      self.cache[funcName] = {};\n    }\n\n    let cacheObject = self.cache[funcName];\n    let hash = getRequestHash(arguments);\n    if (self.cacheEnabled && !self._isExpired(cacheObject[hash])) {\n      return Promise.resolve(cacheObject[hash].value);\n    } else {\n      return func.apply(funcScope, arguments)\n      .then(result => {\n        cacheObject[hash] = {\n          value: result,\n          timestamp: Date.now()\n        };\n        return result;\n      });\n    }\n  };\n}\n\nfunction getRequestHash(args) {\n  const argsJson = JSON.stringify(args);\n  return argsJson.getHash();\n}\n\nString.prototype.getHash = function() {\n  var hash = 0, i, chr, len;\n  if (this.length !== 0) {\n    for (i = 0, len = this.length; i < len; i++) {\n      chr   = this.charCodeAt(i);\n      hash  = ((hash << 5) - hash) + chr;\n      hash |= 0; // Convert to 32bit integer\n    }\n  }\n  return hash;\n};\n"]}